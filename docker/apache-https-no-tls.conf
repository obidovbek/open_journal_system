# Apache configuration for local Docker usage without terminating TLS inside this container.
# We only trust the forwarded HTTPS headers that the reverse proxy (or docker-compose port mapping)
# provides so that OJS continues to think it is being accessed over HTTPS.

# Trust commonly-forwarded HTTPS indicators but do not force redirects.
SetEnvIf X-Forwarded-Proto "^https$" HTTPS=on
SetEnvIf X-Forwarded-Port "^443$" SERVER_PORT=443
SetEnvIf X-Forwarded-SSL "^on$" HTTPS=on

# Enable mod_rewrite just to export HTTPS environment variables when we detect the headers above.
RewriteEngine On
RewriteCond %{HTTP:X-Forwarded-Proto} ^https$ [NC]
RewriteRule .* - [E=HTTPS:on,E=SERVER_PORT:443]

# Provide simple request/response logging that works even when we're sitting behind another proxy.
LogFormat "%a %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\"" proxy_combined
CustomLog /var/www/logs/proxy_access.log proxy_combined
ErrorLog /var/www/logs/proxy_error.log

# Security headers that previously lived in the nginx config, replicated here so the app receives
# the same protections even when nginx is bypassed locally.
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
