# Apache configuration for OJS behind HTTPS reverse proxy
# This ensures Apache and PHP properly detect HTTPS from forwarded headers

# Load required modules
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule setenvif_module modules/mod_setenvif.so

# Set HTTPS environment when forwarded from reverse proxy
SetEnvIf X-Forwarded-Proto "^https$" HTTPS=on
SetEnvIf X-Forwarded-Port "^443$" SERVER_PORT=443
SetEnvIf X-Forwarded-SSL "^on$" HTTPS=on

# Additional security headers for HTTPS
<IfModule mod_headers.c>
    # Force HTTPS for future requests
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
    
    # Prevent mixed content issues
    Header always set Content-Security-Policy "upgrade-insecure-requests" env=HTTPS
</IfModule>

# Rewrite rules to ensure HTTPS URLs
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # If we detect forwarded HTTPS, set environment
    RewriteCond %{HTTP:X-Forwarded-Proto} ^https$ [NC]
    RewriteRule .* - [E=HTTPS:on,E=SERVER_PORT:443]
    
    # For publications.fstu.uz, always assume HTTPS
    RewriteCond %{HTTP_HOST} ^publications\.fstu\.uz$ [NC]
    RewriteRule .* - [E=HTTPS:on,E=SERVER_PORT:443]
</IfModule> 