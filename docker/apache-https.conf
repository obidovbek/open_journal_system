# Apache configuration for OJS behind HTTPS reverse proxy
# This ensures Apache and PHP properly detect HTTPS from forwarded headers

# Set HTTPS environment when forwarded from reverse proxy
SetEnvIf X-Forwarded-Proto "^https$" HTTPS=on
SetEnvIf X-Forwarded-Port "^443$" SERVER_PORT=443
SetEnvIf X-Forwarded-SSL "^on$" HTTPS=on

# Enable rewrite engine for environment detection only (no redirects)
RewriteEngine On

# If we detect forwarded HTTPS, set environment variables only
RewriteCond %{HTTP:X-Forwarded-Proto} ^https$ [NC]
RewriteRule .* - [E=HTTPS:on,E=SERVER_PORT:443]

# For publications.fstu.uz, always assume HTTPS (environment only)
RewriteCond %{HTTP_HOST} ^publications\.fstu\.uz$ [NC]
RewriteRule .* - [E=HTTPS:on,E=SERVER_PORT:443]

# Security headers (but no redirects)
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
Header always set Content-Security-Policy "upgrade-insecure-requests"

# Ensure proper forwarded headers are passed through
Header always set X-Forwarded-Proto "https"
Header always set X-Forwarded-Port "443"

# Additional security headers
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set Referrer-Policy "strict-origin-when-cross-origin" 